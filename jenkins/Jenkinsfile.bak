pipeline {
  agent any

  environment {
    BACKEND_IMAGE = "backend-app"
    FRONTEND_IMAGE = "frontend-app"
  }

  stages {
    stage('Checkout') {
      steps {
        git 'https://github.com/koolkishan/chat-app-react-nodejs.git'
	echo 'Checkout succesfully'
      }
    }

    stage('Build Backend Image') {
      steps {
        dir('server') {
          sh 'docker build -t backend-app .'
	  
        }
      }
    }

    stage('Build Frontend Image') {
      steps {
        dir('public') {
          sh 'docker build -t frontend-app .'
        }
      }
    }

    stage('Stop Previous Containers') {
      steps {
        sh '''
        docker rm -f backend-app || true
        docker rm -f frontend-app || true
        '''
      }
    }

    stage('Run Backend Container') {
      steps {
        sh '''
        docker run -d --name backend-app -p 5000:5000 \
          -e MONGO_URL="mongodb://kritan:kritan@123@host.docker.internal:27017/kritanDb?authSource=admin" \
          backend-app
        '''
      }
    }

    stage('Run Frontend Container') {
      steps {
        sh '''
        docker run -d --name frontend-app -p 3000:3000 \
          -e REACT_APP_API_URL="http://localhost:5000" \
          frontend-app
        '''
      }
    }
	stage('Deploy to kubernetes cluster'){
          steps{ 
            sh '''
	    kubectl set image deployment/your-app your-container=your-registry/your-app:$BUILD_NUMBER

		
}
	}
  }
}
